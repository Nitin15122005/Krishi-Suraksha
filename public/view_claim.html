<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Review Claim - Government Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <div id="headerContainer"></div>

  <main class="max-w-4xl mx-auto p-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-6">
      <a href="dashboard.html" class="hover:text-blue-600">Dashboard</a>
      <span>‚Ä∫</span>
      <a href="schemedetails.html" id="schemeLink" class="hover:text-blue-600">Scheme</a>
      <span>‚Ä∫</span>
      <span class="text-gray-900 font-medium">Review Claim</span>
    </nav>

    <!-- Claim Details Card -->
    <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Claim Review</h1>
        <div id="statusBadge" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
          Loading...
        </div>
      </div>

      <!-- Debug Info -->
      <div id="debugInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-sm hidden">
        <h3 class="font-semibold text-blue-800 mb-2">Debug Information:</h3>
        <div id="debugContent"></div>
      </div>

      <!-- Claim Information -->
      <div id="claimDetails" class="space-y-6">
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
          <p class="text-gray-500 mt-2">Loading claim details...</p>
        </div>
      </div>
    </div>

    <!-- Verification & Action Section -->
    <div id="actionSection" class="bg-white rounded-xl shadow-sm border p-6 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">Verification & Decision</h2>
      
      <!-- Verification Checklist -->
      <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-800 mb-4">Verification Checklist</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" id="verifyIdentity" class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <div>
              <span class="font-medium text-gray-900">Identity Verification</span>
              <p class="text-sm text-gray-500 mt-1">Verify farmer ID and personal details match documentation</p>
            </div>
          </label>
          
          <label class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" id="verifyEligibility" class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <div>
              <span class="font-medium text-gray-900">Eligibility Check</span>
              <p class="text-sm text-gray-500 mt-1">Confirm farmer meets all scheme eligibility criteria</p>
            </div>
          </label>
          
          <label class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" id="verifyDocuments" class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <div>
              <span class="font-medium text-gray-900">Document Validation</span>
              <p class="text-sm text-gray-500 mt-1">Validate all supporting documents are authentic and complete</p>
            </div>
          </label>
          
          <label class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" id="checkDuplicate" class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <div>
              <span class="font-medium text-gray-900">Duplicate Check</span>
              <p class="text-sm text-gray-500 mt-1">Ensure no duplicate claims exist for this farmer</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="border-t pt-6">
        <div class="flex flex-col sm:flex-row gap-4 justify-end">
          <button id="backBtn" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            ‚Üê Back to Scheme
          </button>
          <button id="rejectBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Reject Claim
          </button>
          <button id="approveBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Approve Claim
          </button>
        </div>
      </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Rejection</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
            <select id="rejectReason" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Select a reason</option>
              <option value="Incomplete Documentation">Incomplete Documentation</option>
              <option value="Not Eligible">Not Eligible for Scheme</option>
              <option value="Duplicate Claim">Duplicate Claim</option>
              <option value="False Information">False Information Provided</option>
              <option value="Other">Other Reason</option>
            </select>
          </div>
          <div id="otherReasonDiv" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Specify Reason</label>
            <textarea id="otherReason" placeholder="Please provide details..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
          </div>
          <div class="flex space-x-3 justify-end">
            <button id="cancelRejectBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              Cancel
            </button>
            <button id="confirmRejectBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              Confirm Rejection
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { db, requireLogin, logAction } from './assets/js/firebase.js';
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { loadHeader } from './assets/js/header.js';

    console.log("üöÄ Claim Review Page Started");

    // Require officer to be logged in
    try {
      await requireLogin();
      console.log("‚úÖ User authenticated");
      loadHeader('headerContainer');
    } catch (error) {
      console.error("‚ùå Auth error:", error);
    }

    const params = new URLSearchParams(window.location.search);
    const claimId = params.get('id');
    const schemeId = params.get('scheme');

    console.log("üîç URL Parameters:", { claimId, schemeId });

    let currentClaimData = null;

    // Set up scheme link
    if (schemeId) {
      document.getElementById('schemeLink').href = `schemedetails.html?id=${schemeId}`;
    } else {
      document.getElementById('schemeLink').href = 'dashboard.html';
    }

    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      if (schemeId) {
        window.location.href = `schemedetails.html?id=${schemeId}`;
      } else {
        window.location.href = 'dashboard.html';
      }
    });

    async function loadClaim() {
      console.log("üìÑ Loading claim with ID:", claimId);

      if (!claimId) {
        showError('No claim ID provided in URL');
        return;
      }

      const claimDiv = document.getElementById('claimDetails');
      const actionSection = document.getElementById('actionSection');
      const debugInfo = document.getElementById('debugInfo');

      try {
        const docRef = doc(db, "flaggedClaims", claimId);
        console.log("üîç Firestore document reference:", docRef.path);

        const docSnap = await getDoc(docRef);
        console.log("üìä Document exists:", docSnap.exists());

        if (!docSnap.exists()) {
          claimDiv.innerHTML = `
            <div class="text-center py-8">
              <div class="text-red-400 text-6xl mb-4">‚ùå</div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Claim Not Found</h3>
              <p class="text-gray-500">No claim found with ID: ${claimId}</p>
              <p class="text-sm text-gray-400 mt-2">Please check the claim ID and try again.</p>
            </div>
          `;
          return;
        }

        currentClaimData = docSnap.data();
        console.log("‚úÖ Claim data loaded:", currentClaimData);

        // Show debug info
        debugInfo.classList.remove('hidden');
        document.getElementById('debugContent').innerHTML = `
          <strong>Claim ID:</strong> ${claimId}<br>
          <strong>Scheme:</strong> ${schemeId}<br>
          <strong>Data Fields:</strong> ${Object.keys(currentClaimData).join(', ')}<br>
          <strong>Full Data:</strong><br>
          <pre class="text-xs mt-1 bg-white p-2 rounded border">${JSON.stringify(currentClaimData, null, 2)}</pre>
        `;

        displayClaimDetails(currentClaimData);
        updateStatusBadge(currentClaimData.status);
        
        // Show action section only for pending claims
        if (!currentClaimData.status || currentClaimData.status === 'Pending' || currentClaimData.status === 'Under Review') {
          actionSection.classList.remove('hidden');
          setupActionHandlers(docRef);
          console.log("‚úÖ Action section enabled - claim is pending review");
        } else {
          console.log("‚ÑπÔ∏è Action section hidden - claim status:", currentClaimData.status);
        }

      } catch (error) {
        console.error("‚ùå Error loading claim:", error);
        claimDiv.innerHTML = `
          <div class="text-center py-8">
            <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Claim</h3>
            <p class="text-gray-500 mb-4">Failed to load claim details. Please try again.</p>
            <details class="text-left max-w-md mx-auto bg-red-50 p-3 rounded">
              <summary class="cursor-pointer text-sm">Error Details</summary>
              <pre class="text-xs mt-2 whitespace-pre-wrap">${error.message}</pre>
            </details>
            <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
              Retry
            </button>
          </div>
        `;
      }
    }

    function displayClaimDetails(data) {
      const claimDiv = document.getElementById('claimDetails');
      
      console.log("üé® Displaying claim details with data:", data);
      
      claimDiv.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Farmer Information -->
          <div class="space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Farmer Information</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-600">Full Name</label>
                <p class="text-gray-900 font-medium">${data.name || 'Not provided'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Farmer ID</label>
                <p class="text-gray-900">${data.farmerId || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Contact Information</label>
                <p class="text-gray-900">${data.contact || data.phone || data.mobile || data.email || 'Not provided'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Aadhaar Number</label>
                <p class="text-gray-900">${data.aadhaar || data.aadhaarNumber || 'N/A'}</p>
              </div>
            </div>
          </div>

          <!-- Scheme & Location -->
          <div class="space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Scheme & Location</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-600">Government Scheme</label>
                <p class="text-gray-900 font-medium">${getSchemeName(data.scheme)}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Village</label>
                <p class="text-gray-900">${data.village || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">District</label>
                <p class="text-gray-900">${data.district || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">State</label>
                <p class="text-gray-900">${data.state || 'N/A'}</p>
              </div>
            </div>
          </div>

          <!-- Issue Description -->
          <div class="md:col-span-2 space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Issue Description</h3>
            <div class="bg-gray-50 rounded-lg p-4">
              <p class="text-gray-700">${data.issue || data.description || data.problem || 'No specific issue description provided.'}</p>
            </div>
          </div>

          <!-- Additional Information -->
          <div class="md:col-span-2 space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Additional Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-600">Land Size</label>
                <p class="text-gray-900">${data.landSize || data.area || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Crop Type</label>
                <p class="text-gray-900">${data.crop || data.cropType || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Bank Account</label>
                <p class="text-gray-900">${data.bankAccount || data.accountNumber || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">IFSC Code</label>
                <p class="text-gray-900">${data.ifsc || data.ifscCode || 'N/A'}</p>
              </div>
            </div>
          </div>

          <!-- Documents -->
          <div class="md:col-span-2 space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Supporting Documents</h3>
            ${data.documents && data.documents.length > 0 ? `
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${data.documents.map((url, index) => `
                  <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                      <span class="text-sm font-medium text-gray-700">Document ${index + 1}</span>
                      <a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View ‚Üó
                      </a>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 truncate">${url}</p>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800 text-sm">No documents uploaded for this claim.</p>
              </div>
            `}
          </div>

          <!-- Timeline -->
          <div class="md:col-span-2 space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Timeline</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <label class="block text-sm font-medium text-gray-600">Submitted Date</label>
                <p class="text-gray-900">${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Last Updated</label>
                <p class="text-gray-900">${data.updatedAt ? new Date(data.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
              </div>
            </div>
          </div>
        </div>
      `;

      console.log("‚úÖ Claim details displayed successfully");
    }

    function getSchemeName(schemeId) {
      const schemeNames = {
        pmfby: 'PM Fasal Bima Yojana',
        kcc: 'Kisan Credit Card',
        pmkisan: 'PM Kisan Samman Nidhi'
      };
      return schemeNames[schemeId] || (schemeId ? schemeId.toUpperCase() : 'Unknown Scheme');
    }

    function updateStatusBadge(status) {
      const badge = document.getElementById('statusBadge');
      let badgeClass = '';
      let badgeText = '';

      switch (status) {
        case 'Approved':
          badgeClass = 'bg-green-100 text-green-800';
          badgeText = '‚úÖ Approved';
          break;
        case 'Rejected':
          badgeClass = 'bg-red-100 text-red-800';
          badgeText = '‚ùå Rejected';
          break;
        case 'Under Review':
          badgeClass = 'bg-yellow-100 text-yellow-800';
          badgeText = '‚è≥ Under Review';
          break;
        default:
          badgeClass = 'bg-blue-100 text-blue-800';
          badgeText = 'üìù Pending Review';
      }

      badge.className = `px-4 py-2 rounded-full text-sm font-medium ${badgeClass}`;
      badge.textContent = badgeText;
      
      console.log("‚úÖ Status badge updated:", status);
    }

    function setupActionHandlers(docRef) {
      console.log("‚öôÔ∏è Setting up action handlers");

      const approveBtn = document.getElementById('approveBtn');
      const rejectBtn = document.getElementById('rejectBtn');
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const rejectModal = document.getElementById('rejectModal');
      const cancelRejectBtn = document.getElementById('cancelRejectBtn');
      const confirmRejectBtn = document.getElementById('confirmRejectBtn');
      const rejectReason = document.getElementById('rejectReason');
      const otherReasonDiv = document.getElementById('otherReasonDiv');
      const otherReason = document.getElementById('otherReason');

      // Enable approve button only when all verifications are checked
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allChecked = Array.from(checkboxes).every(cb => cb.checked);
          approveBtn.disabled = !allChecked;
          console.log("‚úÖ Verification checkboxes:", allChecked ? 'All checked' : 'Some unchecked');
        });
      });

      // Reject button opens modal
      rejectBtn.addEventListener('click', () => {
        console.log("‚ùå Reject button clicked");
        rejectModal.classList.remove('hidden');
      });

      // Cancel rejection
      cancelRejectBtn.addEventListener('click', () => {
        console.log("‚Ü©Ô∏è Rejection cancelled");
        rejectModal.classList.add('hidden');
        rejectReason.value = '';
        otherReasonDiv.classList.add('hidden');
      });

      // Handle reason selection
      rejectReason.addEventListener('change', () => {
        if (rejectReason.value === 'Other') {
          otherReasonDiv.classList.remove('hidden');
        } else {
          otherReasonDiv.classList.add('hidden');
        }
      });

      // Confirm rejection
      confirmRejectBtn.addEventListener('click', async () => {
        const reason = rejectReason.value === 'Other' ? otherReason.value : rejectReason.value;
        
        if (!reason.trim()) {
          alert('Please provide a rejection reason.');
          return;
        }

        console.log("‚ùå Confirming rejection with reason:", reason);

        try {
          const auth = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js");
          const officer = auth.getAuth().currentUser;
          
          await updateDoc(docRef, { 
            status: 'Rejected',
            rejectedBy: officer.email,
            rejectedAt: new Date(),
            rejectionReason: reason
          });

          await logAction(claimId, 'REJECTED', `Claim rejected: ${reason}`, officer.email);
          
          alert('‚ùå Claim Rejected Successfully!');
          window.location.href = `schemedetails.html?id=${schemeId}`;
          
        } catch (error) {
          console.error("‚ùå Error rejecting claim:", error);
          alert('Failed to reject claim: ' + error.message);
        }
      });

      // Approve claim
      approveBtn.addEventListener('click', async () => {
        if (!approveBtn.disabled) {
          console.log("‚úÖ Approve button clicked");

          try {
            const auth = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js");
            const officer = auth.getAuth().currentUser;
            
            await updateDoc(docRef, { 
              status: 'Approved',
              approvedBy: officer.email,
              approvedAt: new Date(),
              verifiedChecklist: {
                identity: document.getElementById('verifyIdentity').checked,
                eligibility: document.getElementById('verifyEligibility').checked,
                documents: document.getElementById('verifyDocuments').checked,
                duplicate: document.getElementById('checkDuplicate').checked
              }
            });

            await logAction(claimId, 'APPROVED', 'Claim approved after full verification', officer.email);
            
            alert('‚úÖ Claim Approved Successfully!');
            window.location.href = `schemedetails.html?id=${schemeId}`;
            
          } catch (error) {
            console.error("‚ùå Error approving claim:", error);
            alert('Failed to approve claim: ' + error.message);
          }
        }
      });

      console.log("‚úÖ Action handlers setup complete");
    }

    function showError(message) {
      const claimDiv = document.getElementById('claimDetails');
      claimDiv.innerHTML = `
        <div class="text-center py-8">
          <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">Error</h3>
          <p class="text-gray-500">${message}</p>
        </div>
      `;
    }

    // Load the claim when page is ready
    document.addEventListener('DOMContentLoaded', loadClaim);
    
    // Also try loading if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadClaim);
    } else {
      loadClaim();
    }
  </script>
</body>
</html>