<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports & Analytics - Government Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-beige-50 min-h-screen">

  <!-- Header -->
  <div id="headerContainer"></div>

  <main class="p-6 max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Reports & Analytics</h1>
      <p class="text-gray-700 mt-2">Comprehensive insights and analytics for claim management</p>
    </div>

    <!-- Report Filters -->
    <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6 mb-6">
      <div class="flex flex-col sm:flex-row gap-4 items-end">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
          <div class="flex gap-2">
            <input type="date" id="startDate" class="flex-1 p-2 border border-beige-300 rounded-lg">
            <span class="self-center text-gray-600">to</span>
            <input type="date" id="endDate" class="flex-1 p-2 border border-beige-300 rounded-lg">
          </div>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Scheme</label>
          <select id="schemeFilter" class="w-full p-2 border border-beige-300 rounded-lg">
            <option value="all">All Schemes</option>
            <option value="pmfby">PM Fasal Bima Yojana</option>
            <option value="kcc">Kisan Credit Card</option>
          </select>
        </div>
        <button id="generateReport" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
          Generate Report
        </button>
        <button id="exportReport" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg transition-colors">
          Export PDF
        </button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6 text-center">
        <div class="text-2xl font-bold text-green-600" id="totalClaimsStat">0</div>
        <div class="text-sm text-gray-700 mt-1">Total Claims</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6 text-center">
        <div class="text-2xl font-bold text-blue-600" id="approvedStat">0</div>
        <div class="text-sm text-gray-700 mt-1">Approved</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6 text-center">
        <div class="text-2xl font-bold text-amber-600" id="pendingStat">0</div>
        <div class="text-sm text-gray-700 mt-1">Pending</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6 text-center">
        <div class="text-2xl font-bold text-brown-600" id="rejectedStat">0</div>
        <div class="text-sm text-gray-700 mt-1">Rejected</div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Claims Status Chart -->
      <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Claims Status Distribution</h3>
        <div class="h-64">
          <canvas id="statusChart"></canvas>
        </div>
      </div>

      <!-- Scheme-wise Claims -->
      <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Claims by Scheme</h3>
        <div class="h-64">
          <canvas id="schemeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed Statistics -->
    <div class="bg-white rounded-xl shadow-sm border border-beige-200 p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-6">Detailed Statistics</h3>
      <div id="statisticsContent">
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
          <p class="text-gray-600 mt-2">Loading reports data...</p>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { loadHeader } from './assets/js/header.js';
    import { requireLogin, db } from './assets/js/firebase.js';
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    console.log("üìä Reports Page Started");

    let statusChart, schemeChart;

    // Wait for authentication and load header
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("üìÑ DOM Loaded");
      
      try {
        await requireLogin();
        console.log("‚úÖ User authenticated");
        loadHeader('headerContainer');
      } catch (error) {
        console.error("‚ùå Auth error:", error);
        return;
      }

      // Set default date range (last 30 days)
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      
      document.getElementById('startDate').valueAsDate = startDate;
      document.getElementById('endDate').valueAsDate = endDate;

      // Load initial data
      await loadReportsData();
      
      // Set up event listeners
      document.getElementById('generateReport').addEventListener('click', loadReportsData);
      document.getElementById('exportReport').addEventListener('click', exportToPDF);
    });

    async function loadReportsData() {
      console.log("üìà Loading reports data...");
      
      try {
        const claims = await fetchClaimsData();
        updateQuickStats(claims);
        renderCharts(claims);
        renderStatistics(claims);
        console.log("‚úÖ Reports data loaded successfully");
      } catch (error) {
        console.error("‚ùå Error loading reports:", error);
        showError("Failed to load report data. Please try again.");
      }
    }

    async function fetchClaimsData() {
      const schemeFilter = document.getElementById('schemeFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      console.log("üîç Fetching claims with filters:", { schemeFilter, startDate, endDate });

      try {
        const claimsRef = collection(db, "flaggedClaims");
        const snapshot = await getDocs(claimsRef);
        const claims = [];

        console.log(`üìã Found ${snapshot.size} total claims`);

        snapshot.forEach(doc => {
          const data = doc.data();
          const claimDate = data.timestamp?.toDate() || new Date();
          
          // Apply filters
          let includeClaim = true;
          
          if (schemeFilter !== 'all' && data.scheme !== schemeFilter) {
            includeClaim = false;
          }
          
          if (startDate && endDate) {
            const filterStart = new Date(startDate);
            const filterEnd = new Date(endDate);
            filterEnd.setHours(23, 59, 59, 999); // End of day
            
            if (claimDate < filterStart || claimDate > filterEnd) {
              includeClaim = false;
            }
          }
          
          if (includeClaim) {
            claims.push({ id: doc.id, ...data });
          }
        });

        console.log(`üéØ ${claims.length} claims match the filters`);
        return claims;

      } catch (error) {
        console.error("‚ùå Error fetching claims:", error);
        throw error;
      }
    }

    function updateQuickStats(claims) {
      const totalClaims = claims.length;
      const approvedClaims = claims.filter(claim => claim.status === 'Approved').length;
      const pendingClaims = claims.filter(claim => !claim.status || claim.status === 'Pending' || claim.status === 'Under Review').length;
      const rejectedClaims = claims.filter(claim => claim.status === 'Rejected').length;

      document.getElementById('totalClaimsStat').textContent = totalClaims;
      document.getElementById('approvedStat').textContent = approvedClaims;
      document.getElementById('pendingStat').textContent = pendingClaims;
      document.getElementById('rejectedStat').textContent = rejectedClaims;

      console.log("üìä Quick stats updated:", { totalClaims, approvedClaims, pendingClaims, rejectedClaims });
    }

    function renderCharts(claims) {
      console.log("üìä Rendering charts with", claims.length, "claims");
      
      // Destroy existing charts if they exist
      if (statusChart) statusChart.destroy();
      if (schemeChart) schemeChart.destroy();

      // Status Distribution Chart
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      const statusData = getStatusDistribution(claims);
      
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statusData.labels,
          datasets: [{
            data: statusData.values,
            backgroundColor: [
              '#f59e0b', // amber for pending
              '#3b82f6', // blue for approved
              '#92400e', // brown for rejected
              '#6b7280'  // gray for others
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Scheme Distribution Chart
      const schemeCtx = document.getElementById('schemeChart').getContext('2d');
      const schemeData = getSchemeDistribution(claims);
      
      schemeChart = new Chart(schemeCtx, {
        type: 'bar',
        data: {
          labels: schemeData.labels,
          datasets: [{
            label: 'Number of Claims',
            data: schemeData.values,
            backgroundColor: '#10b981',
            borderColor: '#047857',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      console.log("‚úÖ Charts rendered successfully");
    }

    function renderStatistics(claims) {
      console.log("üìà Rendering statistics for", claims.length, "claims");
      
      const statistics = calculateStatistics(claims);
      const container = document.getElementById('statisticsContent');
      
      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="text-center p-4 bg-green-50 rounded-lg border border-green-200">
            <div class="text-2xl font-bold text-green-700">${statistics.totalClaims}</div>
            <div class="text-sm text-green-600">Total Claims</div>
          </div>
          <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="text-2xl font-bold text-blue-700">${statistics.approvalRate}%</div>
            <div class="text-sm text-blue-600">Approval Rate</div>
          </div>
          <div class="text-center p-4 bg-amber-50 rounded-lg border border-amber-200">
            <div class="text-2xl font-bold text-amber-700">${statistics.uniqueFarmers}</div>
            <div class="text-sm text-amber-600">Unique Farmers</div>
          </div>
          <div class="text-center p-4 bg-brown-50 rounded-lg border border-brown-200">
            <div class="text-2xl font-bold text-brown-700">${statistics.avgProcessingTime}</div>
            <div class="text-sm text-brown-600">Avg Processing Days</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <h4 class="font-semibold text-gray-800 mb-4">Status Breakdown</h4>
            <div class="space-y-3">
              ${statistics.statusBreakdown.map(item => `
                <div class="flex justify-between items-center p-3 bg-beige-50 rounded-lg border border-beige-200">
                  <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-3 ${getStatusColor(item.status)}"></div>
                    <span class="text-sm font-medium text-gray-700">${item.status}</span>
                  </div>
                  <div class="text-right">
                    <span class="font-bold text-gray-900">${item.count}</span>
                    <span class="text-sm text-gray-600 ml-2">(${item.percentage}%)</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div>
            <h4 class="font-semibold text-gray-800 mb-4">Scheme Performance</h4>
            <div class="space-y-3">
              ${statistics.schemePerformance.map(scheme => `
                <div class="flex justify-between items-center p-3 bg-beige-50 rounded-lg border border-beige-200">
                  <span class="text-sm font-medium text-gray-700">${scheme.name}</span>
                  <div class="text-right">
                    <span class="font-bold text-gray-900">${scheme.count}</span>
                    <span class="text-sm text-gray-600 ml-2">claims</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>

        <div class="mt-8">
          <h4 class="font-semibold text-gray-800 mb-4">Monthly Trend</h4>
          <div class="bg-beige-50 rounded-lg border border-beige-200 p-4">
            <p class="text-gray-700 text-sm">
              <strong>Report Period:</strong> ${statistics.reportPeriod}<br>
              <strong>Data Last Updated:</strong> ${new Date().toLocaleDateString()}
            </p>
          </div>
        </div>
      `;

      console.log("‚úÖ Statistics rendered successfully");
    }

    function getStatusDistribution(claims) {
      const statusCount = {
        'Pending': 0,
        'Approved': 0,
        'Rejected': 0,
        'Other': 0
      };

      claims.forEach(claim => {
        const status = claim.status || 'Pending';
        if (statusCount.hasOwnProperty(status)) {
          statusCount[status]++;
        } else {
          statusCount['Other']++;
        }
      });

      return {
        labels: Object.keys(statusCount),
        values: Object.values(statusCount)
      };
    }

    function getSchemeDistribution(claims) {
      const schemeCount = {};
      
      claims.forEach(claim => {
        const scheme = claim.scheme || 'Unknown';
        schemeCount[scheme] = (schemeCount[scheme] || 0) + 1;
      });

      return {
        labels: Object.keys(schemeCount),
        values: Object.values(schemeCount)
      };
    }

    function calculateStatistics(claims) {
      const totalClaims = claims.length;
      const approvedClaims = claims.filter(claim => claim.status === 'Approved').length;
      const pendingClaims = claims.filter(claim => !claim.status || claim.status === 'Pending' || claim.status === 'Under Review').length;
      const rejectedClaims = claims.filter(claim => claim.status === 'Rejected').length;
      
      const approvalRate = totalClaims > 0 ? Math.round((approvedClaims / totalClaims) * 100) : 0;
      
      // Get unique farmers (assuming farmerId field exists)
      const uniqueFarmers = new Set(claims.map(claim => claim.farmerId || claim.farmerName || 'Unknown')).size;
      
      // Calculate average processing time (simplified)
      const avgProcessingTime = Math.round(Math.random() * 5) + 1; // Mock data
      
      // Status breakdown
      const statusBreakdown = [
        { status: 'Pending', count: pendingClaims, percentage: Math.round((pendingClaims / totalClaims) * 100) },
        { status: 'Approved', count: approvedClaims, percentage: Math.round((approvedClaims / totalClaims) * 100) },
        { status: 'Rejected', count: rejectedClaims, percentage: Math.round((rejectedClaims / totalClaims) * 100) }
      ];

      // Scheme performance
      const schemePerformance = Object.entries(getSchemeDistribution(claims))
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const reportPeriod = startDate && endDate 
        ? `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`
        : 'All Time';

      return {
        totalClaims,
        approvalRate,
        uniqueFarmers,
        avgProcessingTime,
        statusBreakdown,
        schemePerformance,
        reportPeriod
      };
    }

    function getStatusColor(status) {
      switch (status) {
        case 'Pending': return 'bg-amber-400';
        case 'Approved': return 'bg-green-400';
        case 'Rejected': return 'bg-brown-400';
        default: return 'bg-gray-400';
      }
    }

    function exportToPDF() {
      alert('PDF export functionality would be implemented here. This would generate a comprehensive report with all charts and statistics.');
      console.log("üìÑ PDF export triggered");
    }

    function showError(message) {
      const container = document.getElementById('statisticsContent');
      container.innerHTML = `
        <div class="text-center py-8">
          <div class="text-brown-400 text-6xl mb-4">‚ö†Ô∏è</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to Load Reports</h3>
          <p class="text-gray-600 mb-4">${message}</p>
          <button onclick="loadReportsData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
            Retry
          </button>
        </div>
      `;
    }
  </script>

  <style>
    .bg-beige-50 { background-color: #fefaf0; }
    .bg-beige-100 { background-color: #fdf6e3; }
    .border-beige-200 { border-color: #faf0d7; }
    .border-beige-300 { border-color: #e5d5b8; }
    
    .bg-green-50 { background-color: #f0fdf4; }
    .bg-blue-50 { background-color: #f0f9ff; }
    .bg-amber-50 { background-color: #fffbeb; }
    .bg-brown-50 { background-color: #fef7ed; }
    
    .border-green-200 { border-color: #bbf7d0; }
    .border-blue-200 { border-color: #bae6fd; }
    .border-amber-200 { border-color: #fde68a; }
    .border-brown-200 { border-color: #fed7aa; }
  </style>
</body>
</html>